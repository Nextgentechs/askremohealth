name: ðŸš€ Deploy to Staging (staging.askremohealth)

on:
  push:
    branches: ['staging-config']
  workflow_dispatch:

jobs:
  deploy-staging:
    name: ðŸ“¦ Deploy to Staging Subdomain
    runs-on: ubuntu-latest

    # Optional: tie to a "staging" Environment in GitHub for per-env secrets/approvals
    environment:
      name: staging
      url: https://staging.askremohealth

    env:
      BRANCH: staging-config
      REPO_DIR: /root/askremohealth-staging         # â¬…ï¸ staging clone path on your Contabo VPS
      SERVICE: askremohealth-staging.service        # â¬…ï¸ systemd service for staging
      HEALTH_URL: http://localhost:3001             # â¬…ï¸ or use https://staging.askremohealth/health
      GIT_URL: git@github.com:Nextgentechs/askremohealth.git
      WEB_WORKSPACE: apps/web                       # â¬…ï¸ if monorepo; leave as-is or set to ""

    steps:
      - name: ðŸ“¥ Checkout (for metadata only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸš€ Deploy via SSH (systemd)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # =============================================================================
            # Staging Deployment â€” staging.askremohealth (systemd)
            # =============================================================================
            set -Eeuo pipefail
            trap 'echo "âŒ Failed at line $LINENO. Last cmd: $BASH_COMMAND"' ERR
            set -x

            BRANCH="${BRANCH:-staging-config}"
            REPO_DIR="${REPO_DIR:-/root/askremohealth-staging}"
            SERVICE="${SERVICE:-askremohealth-staging.service}"
            HEALTH_URL="${HEALTH_URL:-http://localhost:3001}"
            GIT_URL="${GIT_URL:-git@github.com:Nextgentechs/askremohealth.git}"
            WEB_WORKSPACE="${WEB_WORKSPACE:-apps/web}"

            echo "ðŸ”„ Starting STAGING deployment for branch '${BRANCH}'..."

            # Ensure repo exists; clone if first run
            if [ ! -d "$REPO_DIR/.git" ]; then
              mkdir -p "$REPO_DIR"
              rm -rf "$REPO_DIR"
              git clone --origin origin --branch "$BRANCH" "$GIT_URL" "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            test "$(pwd)" = "$REPO_DIR"

            # Heal remote-tracking refs to avoid lock-ref errors
            git remote set-url origin "$GIT_URL"
            git remote prune origin || true
            git update-ref -d "refs/remotes/origin/$BRANCH" || true
            git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"

            # Ensure the remote branch exists
            git rev-parse --verify "refs/remotes/origin/$BRANCH"

            # Wrapper-safe local branch selection (no non-zero on condition)
            local_sha="$(git show-ref --heads -s "$BRANCH" 2>/dev/null || true)"
            case "$local_sha" in
              "")
                git checkout -B "$BRANCH" "refs/remotes/origin/$BRANCH"
                ;;
              *)
                git checkout "$BRANCH"
                ;;
            esac

            # Hard reset to remote tip for clean build
            git reset --hard "refs/remotes/origin/$BRANCH"
            echo "ðŸ“¥ Synced to origin/${BRANCH} at $(git rev-parse --short HEAD)"

            echo "ðŸ“¦ Installing npm dependencies..."
            if [ -f package-lock.json ]; then
              npm ci || npm install
            else
              npm install
            fi

            echo "ðŸ› ï¸ Building app for STAGING..."
            # Support monorepo (apps/web). If WEB_WORKSPACE exists, build it; else root build
            if [ -n "$WEB_WORKSPACE" ] && [ -f "$WEB_WORKSPACE/package.json" ]; then
              rm -rf "$WEB_WORKSPACE/.next" || true
              npm run build --workspace="$WEB_WORKSPACE"
            else
              rm -rf .next || true
              npm run build
            fi

            echo "ðŸ”„ Restarting systemd service: ${SERVICE}"
            systemctl restart "${SERVICE}"
            systemctl status "${SERVICE}" --no-pager || true

            echo "â³ Health check (retries)..."
            for i in $(seq 1 12); do
              if curl -fsS "$HEALTH_URL" >/dev/null; then
                echo "âœ… Staging healthy at ${HEALTH_URL}"
                break
              fi
              echo "â³ Attempt $i/12: not ready, retrying in 5s..."
              sleep 5
            done
            # Final assert
            curl -fsS "$HEALTH_URL" >/dev/null

            echo "ðŸŽ‰ Staging deployment completed successfully."
