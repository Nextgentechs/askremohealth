name: ğŸš§ Deploy AskRemoHealth (Staging)

on:
  push:
    branches:
      - staging-config

permissions:
  contents: read

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  deploy:
    name: ğŸ“¦ Deploy to Staging
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout (for metadata only)
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy via SSH (staging)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            echo "ğŸ”„ Starting staging deployment..."

            # --- Config ---
            BRANCH="staging-config"
            APP_DIR="/root/askremohealth-staging"
            SERVICE="askremohealth-staging.service"
            HEALTH_URL="http://localhost:3001"

            echo "ğŸ“ Using APP_DIR=${APP_DIR}"
            echo "ğŸŒ¿ Using BRANCH=${BRANCH}"
            echo "ğŸ§© Using SERVICE=${SERVICE}"
            echo "ğŸ©º Health check URL: ${HEALTH_URL}"

            # --- Code update ---
            cd "${APP_DIR}"
            echo "ğŸ“¥ Fetching latest code..."
            git fetch --all --prune
            git checkout "${BRANCH}"
            # Reset to remote to avoid drift
            git reset --hard "origin/${BRANCH}"
            git pull --ff-only origin "${BRANCH}"

            # --- Dependencies & build ---
            echo "ğŸ“¦ Installing dependencies..."
            # Use install (not ci) to avoid lockfile mismatch issues
            npm install

            echo "ğŸ› ï¸ Building Next.js app..."
            rm -rf .next
            npm run build

            # --- Stop existing service and cleanup ---
            echo "ğŸ›‘ Stopping existing service and cleaning up port 3001..."
            systemctl stop "${SERVICE}" || true
            
            echo "ğŸ”« Killing any process using port 3001..."
            fuser -k 3001/tcp || true
            
            echo "â³ Waiting for cleanup..."
            sleep 5

            # --- Restart systemd service ---
            echo "ğŸ”„ Restarting systemd service: ${SERVICE}"
            systemctl daemon-reload || true
            systemctl restart "${SERVICE}"
            sleep 5

            echo "ğŸ§ª Checking service status..."
            if systemctl is-active --quiet "${SERVICE}"; then
              echo "âœ… ${SERVICE} is active."
            else
              echo "âŒ ${SERVICE} failed to start. Recent logs:"
              journalctl -u "${SERVICE}" --no-pager -n 100
              exit 1
            fi

            # --- Reload Nginx (for subdomain proxy) ---
            echo "ğŸ” Reloading Nginx..."
            if nginx -t; then
              systemctl reload nginx
              echo "âœ… Nginx reloaded."
            else
              echo "âŒ Nginx config test failed!"
              exit 1
            fi

            # --- Health check ---
            echo "â³ Waiting for app to be ready..."
            sleep 8
            echo "ğŸ” Health check: ${HEALTH_URL}"
            if curl -fsSL --max-time 10 "${HEALTH_URL}" >/dev/null; then
              echo "ğŸ‰ Staging deployment successful and responding."
            else
              echo "âš ï¸ Health check failed at ${HEALTH_URL}"
              echo "ğŸ” Showing last 100 logs from ${SERVICE}:"
              journalctl -u "${SERVICE}" --no-pager -n 100
              exit 1
            fi

            echo "âœ… Staging deploy finished."
