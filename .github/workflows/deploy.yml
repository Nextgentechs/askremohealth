name: Deploy to Staging & Merge to Staging.env

on:
  push:
    branches:
      - 'feature/*'       # Trigger deployment on feature branches
  pull_request:
    branches:
      - 'Staging.env'     # Trigger deployment when PR is made to staging.env

jobs:
  deploy:
    name: Deploy to Staging Subdomain & Merge to Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Staging Subdomain via SSH
        if: github.ref == 'refs/heads/Staging.env'  # Deploy to staging when changes are pushed to staging.env
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          STAGING_SERVER: ${{ secrets.STAGING_SERVER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY root@$STAGING_SERVER << 'EOF'
            cd /root/askremohealth-staging/apps/web
            git pull origin Staging.env  # Pull the latest from staging.env
            npm install
            npm run build
            npm run start
          EOF

      - name: Merge Feature Branch to Staging.env (on PR to Staging)
        if: github.event_name == 'pull_request' && github.ref == 'refs/heads/Staging.env'
        run: |
          echo "ðŸ”€ Merging feature branch into staging.env..."
          git checkout Staging.env
          git pull origin Staging.env
          git merge ${GITHUB_HEAD_REF} --no-edit
          git push origin Staging.env
