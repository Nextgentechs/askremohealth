name: üöÄ Deploy AskRemoHealth Production
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    name: üî® Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üìã Node.js Version Check
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üî® Build Next.js (Standalone)
        run: |
          cd apps/web
          SKIP_ENV_VALIDATION=true npx next build
          echo "üìã Build completed. Routes generated:"
          ls -la .next/server/app/ 2>/dev/null | head -20 || echo "Checking route structure..."
          find .next/server/app -maxdepth 2 -type d 2>/dev/null | head -30 || true
        env:
          SKIP_ENV_VALIDATION: 'true'
          # Required for build - these are used by API routes during page data collection
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: '/auth'
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: '/auth'
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_API_KEY_SECRET: ${{ secrets.TWILIO_API_KEY_SECRET }}
          TWILIO_API_KEY_SID: ${{ secrets.TWILIO_API_KEY_SID }}
          FROM_EMAIL: 'info@askremohealth.com'

      - name: üìÅ Prepare Standalone Package
        run: |
          # Copy static assets to standalone
          cp -r apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static
          cp -r apps/web/public apps/web/.next/standalone/apps/web/public

          # Create a simple start script
          echo '#!/bin/bash' > apps/web/.next/standalone/start.sh
          echo 'cd /root/askremohealth/apps/web/.next/standalone/apps/web' >> apps/web/.next/standalone/start.sh
          echo 'NODE_ENV=production node server.js' >> apps/web/.next/standalone/start.sh
          chmod +x apps/web/.next/standalone/start.sh

          # Create tarball for faster transfer
          tar -czf standalone-build.tar.gz -C apps/web/.next standalone
          ls -lh standalone-build.tar.gz

      - name: üöÄ Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üîÑ Preparing deployment..."
            cd /root/askremohealth

            # Sync code for any non-built files
            git fetch origin main
            git reset --hard origin/main

            echo "‚úÖ Ready for artifact upload"

      - name: üì§ Upload Build Artifacts
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'standalone-build.tar.gz'
          target: '/root/askremohealth/'

      - name: üîß Extract & Start Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /root/askremohealth

            echo "üì¶ Extracting build artifacts..."
            rm -rf apps/web/.next/standalone
            tar -xzf standalone-build.tar.gz -C apps/web/.next/
            rm standalone-build.tar.gz

            echo "üîÑ Restarting PM2..."
            cd apps/web/.next/standalone/apps/web
            pm2 delete askremohealth-web 2>/dev/null || true
            pm2 start server.js --name askremohealth-web --node-args="--max-old-space-size=512" -e /root/askremohealth/logs/error.log -o /root/askremohealth/logs/output.log
            pm2 save

            echo "üîÅ Reloading Nginx..."
            nginx -t && systemctl reload nginx

            echo "‚è≥ Waiting for app to start..."
            sleep 10

            echo "üîç Health check..."
            pm2 status askremohealth-web

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [[ "$HTTP_CODE" =~ ^[2345] ]]; then
              echo "‚úÖ Deployment successful! HTTP Status: $HTTP_CODE"
            else
              echo "‚ö†Ô∏è App not responding properly. HTTP Status: $HTTP_CODE"
              pm2 logs askremohealth-web --lines 30 --nostream
              exit 1
            fi

            # Test homepage specifically
            if curl -s http://localhost:3000 | grep -q "html"; then
              echo "‚úÖ Homepage rendering HTML content!"
            else
              echo "‚ö†Ô∏è Homepage may not be rendering correctly"
            fi

            echo "üéâ Deployment completed successfully!"
