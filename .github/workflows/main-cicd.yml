name: üöÄ Deploy AskRemoHealth Production
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: üì¶ Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: üìù Log trigger
        run: echo "Deploying AskRemoHealth to production..."

      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            set -e
            echo "üîÑ Starting deployment..."

            # 1. Navigate to App Directory
            cd /root/askremohealth
            echo "üìÅ Working in /root/askremohealth"

            # 2. Force sync with origin/main
            echo "üì• Syncing with origin/main..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            echo "‚úÖ Synced with origin/main"

            # 3. Check Node.js version and upgrade if needed
            echo "ÔøΩ Current Node.js version:"
            node --version || { echo "Node not found"; exit 1; }
            npm --version || { echo "npm not found"; exit 1; }

            # Check if Node.js 20+ is available
            NODE_MAJOR=$(node --version | cut -d'.' -f1 | tr -d 'v')
            if [ "$NODE_MAJOR" -lt 20 ]; then
              echo "‚ö†Ô∏è Node.js $NODE_MAJOR detected, need v20. Attempting upgrade..."
              # Try using n to upgrade
              npm install -g n
              n 20
              hash -r
              echo "üìã New Node.js version:"
              node --version
            fi

            # 4. Install Dependencies
            echo "üì¶ Installing dependencies..."
            npm install

            # 5. Build the Next.js App
            echo "üßπ Cleaning build caches..."
            rm -rf apps/web/.next
            rm -rf .turbo
            rm -rf node_modules/.cache

            echo "üõ†Ô∏è Building Next.js..."
            cd apps/web
            SKIP_ENV_VALIDATION=true npx next build 2>&1 | tee ../../build.log

            # Show what routes were generated
            echo "üìã Generated routes:"
            find .next/server/app -maxdepth 2 -type d 2>/dev/null | head -30 || true

            cd ../..

            # 6. Setup Standalone Output for PM2
            echo "üìã Preparing standalone deployment..."
            cp -r apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static
            cp -r apps/web/public apps/web/.next/standalone/apps/web/public

            # 7. Restart PM2 with Standalone Server
            echo "üîÑ Restarting PM2..."
            cd apps/web/.next/standalone/apps/web
            pm2 delete askremohealth-web 2>/dev/null || true
            pm2 start server.js --name askremohealth-web --env production
            pm2 save
            cd /root/askremohealth

            # 8. Reload Nginx
            echo "üîÅ Reloading Nginx..."
            nginx -t && systemctl reload nginx
            echo "‚úÖ Nginx reloaded"

            # 9. Health Check
            echo "‚è≥ Waiting for app to start..."
            sleep 15

            pm2 status askremohealth-web

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úÖ SUCCESS! Homepage returns HTTP 200!"
            elif [[ "$HTTP_CODE" =~ ^[2345] ]]; then
              echo "‚ö†Ô∏è App responding with HTTP $HTTP_CODE (may need route fixes)"
            else
              echo "‚ùå App not responding. HTTP Status: $HTTP_CODE"
              pm2 logs askremohealth-web --lines 30 --nostream
              exit 1
            fi

            echo "üéâ Deployment completed!"
