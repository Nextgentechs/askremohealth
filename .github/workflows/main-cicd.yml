name: ðŸš€ Deploy AskRemoHealth to cPanel
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    name: ðŸ“¦ Build & Deploy to cPanel
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“ Log trigger
        run: echo "Building and deploying AskRemoHealth to cPanel..."

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ“ Create production .env file
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          TWILIO_API_KEY_SECRET: ${{ secrets.TWILIO_API_KEY_SECRET }}
          TWILIO_API_KEY_SID: ${{ secrets.TWILIO_API_KEY_SID }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # Redis (Upstash)
          REDIS_URL: ${{ secrets.REDIS_URL }}
          REDIS_TOKEN: ${{ secrets.REDIS_TOKEN }}
          OBJECT_STORAGE_KEY: ${{ secrets.OBJECT_STORAGE_KEY }}
          OBJECT_STORAGE_SECRET: ${{ secrets.OBJECT_STORAGE_SECRET }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          NEXT_PUBLIC_CLOUDINARY_API_KEY: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          cat > apps/web/.env << EOF
          # Production Environment for AskRemoHealth
          DATABASE_URL="${DATABASE_URL}"
          JWT_SECRET="${JWT_SECRET}"
          GOOGLE_MAPS_API_KEY="${GOOGLE_MAPS_API_KEY}"
          CRON_SECRET="${CRON_SECRET}"
          TWILIO_API_KEY_SECRET="${TWILIO_API_KEY_SECRET}"
          TWILIO_API_KEY_SID="${TWILIO_API_KEY_SID}"
          TWILIO_ACCOUNT_SID="${TWILIO_ACCOUNT_SID}"
          TWILIO_AUTH_TOKEN="${TWILIO_AUTH_TOKEN}"
          CLERK_SECRET_KEY="${CLERK_SECRET_KEY}"
          RESEND_API_KEY="${RESEND_API_KEY}"
          # Redis Configuration
          REDIS_URL="${REDIS_URL}"
          REDIS_TOKEN="${REDIS_TOKEN}"

          FROM_EMAIL="info@askremohealth.com"
          OBJECT_STORAGE_ENDPOINT="https://eu2.contabostorage.com"
          OBJECT_STORAGE_REGION="eu2"
          OBJECT_STORAGE_BUCKET="askremohealth"
          OBJECT_STORAGE_KEY="${OBJECT_STORAGE_KEY}"
          OBJECT_STORAGE_SECRET="${OBJECT_STORAGE_SECRET}"
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}"
          NEXT_PUBLIC_CLERK_SIGN_IN_URL="/auth"
          NEXT_PUBLIC_CLERK_SIGN_UP_URL="/auth"
          NEXT_PUBLIC_RESEND_API_KEY="${RESEND_API_KEY}"
          NEXT_PUBLIC_FROM_EMAIL="info@askremohealth.com"
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="${NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME}"
          NEXT_PUBLIC_CLOUDINARY_API_KEY="${NEXT_PUBLIC_CLOUDINARY_API_KEY}"
          CLOUDINARY_API_SECRET="${CLOUDINARY_API_SECRET}"
          NODE_ENV="production"
          EOF
          echo "âœ… .env file created"
          echo "Verifying RESEND_API_KEY is set..."
          grep "RESEND_API_KEY" apps/web/.env | head -1

      - name: ðŸ› ï¸ Build Next.js
        run: |
          cd apps/web
          SKIP_ENV_VALIDATION=true npx next build
          echo "âœ… Build completed"

      - name: ðŸ“‹ Prepare Standalone Deployment
        run: |
          cd apps/web/.next/standalone
          # Copy static files (from .next/static to standalone/.../static)
          # Note: ../static refers to apps/web/.next/static
          cp -r ../static apps/web/.next/static
          cp -r ../../public apps/web/public

          # Create .env file in standalone root and app directory for safety
          cp ../../.env apps/web/.env
          cp ../../.env .env

          # Copy ecosystem.config.js if exists
          cp ../../ecosystem.config.js .

          echo "âœ… Standalone deployment prepared"
          ls -la

      - name: ðŸ“¦ Create deployment package
        run: |
          cd apps/web/.next/standalone
          # Create a compressed archive of the ROOT standalone directory
          tar -czf ../../../../deploy-package.tar.gz .
          echo "âœ… Deployment package created"
          ls -la ../../../../deploy-package.tar.gz

      - name: ðŸš€ Deploy to cPanel via FTP
        run: |
          # Install lftp
          sudo apt-get update && sudo apt-get install -y lftp

          # Deploy using lftp from the STANDALONE ROOT
          cd apps/web/.next/standalone

          echo "ðŸ“‚ Uploading files to cPanel..."
          # Note: Mirroring the standalone root which includes node_modules, server.js, and apps/web
          lftp -u "${{ secrets.CPANEL_FTP_USER }},${{ secrets.CPANEL_FTP_PASSWORD }}" \
               -e "set ssl:verify-certificate no; set ftp:passive-mode yes; mirror -R --verbose --exclude-glob .git* --exclude-glob .next/cache/ --parallel=10 . /repositories/askremohealth/; bye" \
               "ftp://${{ secrets.CPANEL_FTP_HOST }}"

          echo "âœ… FTP Upload completed!"

      - name: ðŸ“ Deployment Summary
        run: |
          echo "ðŸŽ‰ Deployment to cPanel completed!"
          echo ""
          echo "Deployed to: https://askremohealth.com"
          echo "FTP Server: ${{ secrets.CPANEL_FTP_HOST }}"
          echo "Deploy Path: /repositories/askremohealth/"
          echo "Entry Point: server.js (at root)"
