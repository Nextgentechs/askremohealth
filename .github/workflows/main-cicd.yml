name: ðŸš€ Deploy AskRemoHealth to cPanel
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    name: ðŸ“¦ Build & Deploy to cPanel
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“ Log trigger
        run: echo "Building and deploying AskRemoHealth to cPanel..."

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ“ Create production .env file
        run: |
          cat > apps/web/.env << 'EOF'
          # Production Environment for AskRemoHealth
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          GOOGLE_MAPS_API_KEY="${{ secrets.GOOGLE_MAPS_API_KEY }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          TWILIO_API_KEY_SECRET="${{ secrets.TWILIO_API_KEY_SECRET }}"
          TWILIO_API_KEY_SID="${{ secrets.TWILIO_API_KEY_SID }}"
          TWILIO_ACCOUNT_SID="${{ secrets.TWILIO_ACCOUNT_SID }}"
          TWILIO_AUTH_TOKEN="${{ secrets.TWILIO_AUTH_TOKEN }}"
          CLERK_SECRET_KEY="${{ secrets.CLERK_SECRET_KEY }}"
          RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
          FROM_EMAIL="info@askremohealth.com"
          OBJECT_STORAGE_ENDPOINT="https://eu2.contabostorage.com"
          OBJECT_STORAGE_REGION="eu2"
          OBJECT_STORAGE_BUCKET="askremohealth"
          OBJECT_STORAGE_KEY="${{ secrets.OBJECT_STORAGE_KEY }}"
          OBJECT_STORAGE_SECRET="${{ secrets.OBJECT_STORAGE_SECRET }}"
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}"
          NEXT_PUBLIC_CLERK_SIGN_IN_URL="/auth"
          NEXT_PUBLIC_CLERK_SIGN_UP_URL="/auth"
          NEXT_PUBLIC_RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
          NEXT_PUBLIC_FROM_EMAIL="info@askremohealth.com"
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}"
          NEXT_PUBLIC_CLOUDINARY_API_KEY="${{ secrets.NEXT_PUBLIC_CLOUDINARY_API_KEY }}"
          CLOUDINARY_API_SECRET="${{ secrets.CLOUDINARY_API_SECRET }}"
          NODE_ENV="production"
          EOF
          echo "âœ… .env file created"

      - name: ðŸ› ï¸ Build Next.js
        run: |
          cd apps/web
          SKIP_ENV_VALIDATION=true npx next build
          echo "âœ… Build completed"

      - name: ðŸ“‹ Prepare Standalone Deployment
        run: |
          cd apps/web/.next/standalone
          # Copy static files and public folder
          cp -r ../../static apps/web/.next/static
          cp -r ../../public apps/web/public

          # Create .env file in standalone
          cp ../../.env apps/web/.env

          echo "âœ… Standalone deployment prepared"
          ls -la apps/web/

      - name: ðŸ“¦ Create deployment package
        run: |
          cd apps/web/.next/standalone/apps/web
          # Create a compressed archive
          tar -czf ../../../../../../deploy-package.tar.gz .
          echo "âœ… Deployment package created"
          ls -la ../../../../../../deploy-package.tar.gz

      - name: ðŸš€ Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_HOST }}
          username: ${{ secrets.CPANEL_FTP_USER }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: ./apps/web/.next/standalone/apps/web/
          server-dir: /repositories/askremohealth/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/node_modules/**
            **/.next/cache/**

      - name: ðŸ“ Deployment Summary
        run: |
          echo "ðŸŽ‰ Deployment to cPanel completed!"
          echo ""
          echo "Deployed to: https://askremohealth.com"
          echo "FTP Server: ${{ secrets.CPANEL_FTP_HOST }}"
          echo "Deploy Path: /repositories/askremohealth/"
