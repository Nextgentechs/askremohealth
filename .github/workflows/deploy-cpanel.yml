name: ðŸš€ Deploy to cPanel (askremohealth.com)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build step (deploy existing code)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20.x'
  APP_DIR: apps/web
  DEPLOY_PATH: /home/deueoltk/public_html/apps/web

jobs:
  # ============================================================================
  # BUILD JOB
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_build != 'true' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.APP_DIR }}/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm ci
        working-directory: ${{ env.APP_DIR }}

      - name: ðŸ” Type Check
        run: npm run typecheck
        working-directory: ${{ env.APP_DIR }}
        continue-on-error: true

      - name: ðŸ“ Lint
        run: npm run lint
        working-directory: ${{ env.APP_DIR }}
        continue-on-error: true

      - name: ðŸ—ï¸ Build Next.js
        run: npm run build
        working-directory: ${{ env.APP_DIR }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_APP_URL: https://askremohealth.com
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          SKIP_ENV_VALIDATION: 1

      - name: ðŸ“¦ Create Deployment Package
        run: |
          cd ${{ env.APP_DIR }}
          mkdir -p deploy-package

          # Copy production files
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp server.js deploy-package/
          cp next.config.js deploy-package/
          cp ecosystem.config.js deploy-package/

          # Create required directories
          mkdir -p deploy-package/logs
          mkdir -p deploy-package/tmp

          echo "âœ… Deployment package created"
          ls -la deploy-package/

      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: ${{ env.APP_DIR }}/deploy-package
          retention-days: 1

  # ============================================================================
  # DEPLOY JOB (SSH)
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy via SSH
    runs-on: ubuntu-latest
    needs: build
    if: always() && (needs.build.result == 'success' || github.event.inputs.skip_build == 'true')

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Build Artifact
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: deploy-package

      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ðŸ“¤ Upload Files via rsync
        run: |
          rsync -avz --delete \
            --exclude '.env' \
            --exclude '.env.*' \
            --exclude 'node_modules' \
            --exclude 'logs/*' \
            ./deploy-package/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: ðŸ”§ Install Dependencies & Restart
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."

            # Navigate to app directory
            cd ${{ env.DEPLOY_PATH }}

            # Activate Node.js environment (cPanel)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Or use cPanel's Node.js selector
            source ~/nodevenv/apps/web/20/bin/activate 2>/dev/null || true

            # Create required directories
            mkdir -p logs tmp

            # Install production dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --production --ignore-scripts 2>&1 | tail -10

            # Restart application
            echo "ðŸ”„ Restarting application..."

            # Method 1: PM2 (if available)
            if command -v pm2 &> /dev/null; then
              pm2 restart ecosystem.config.js --env production 2>/dev/null || \
              pm2 start ecosystem.config.js --env production
              pm2 save
              echo "âœ… PM2 restart complete"
            fi

            # Method 2: cPanel Passenger
            touch tmp/restart.txt
            echo "âœ… Touched restart.txt for Passenger"

            echo "ðŸŽ‰ Deployment complete!"

      - name: â³ Wait for Application Start
        run: sleep 30

      - name: ðŸ” Health Check
        run: |
          echo "Checking if site is live..."
          for i in {1..5}; do
            if curl -sf https://askremohealth.com > /dev/null; then
              echo "âœ… Site is live!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "âš ï¸ Site may not be responding. Check server logs."
          # Don't fail the build, just warn
          exit 0

  # ============================================================================
  # NOTIFICATION
  # ============================================================================
  notify:
    name: ðŸ“¬ Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: ðŸ“¬ Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… **Status:** Deployment successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Live Site:** https://askremohealth.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
