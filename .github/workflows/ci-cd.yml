# =============================================================================
# CI/CD Pipeline for Ask Remo Health
# =============================================================================
#
# This workflow runs on:
# - All pushes to dev and main branches
# - All pull requests targeting dev or main
#
# Jobs:
# 1. lint-and-typecheck: ESLint and TypeScript validation
# 2. build: Production build verification
#
# Branch Strategy (Git Flow Lite):
# - main: Production deployments
# - dev: Staging/integration
# - feature/*: Feature development
# - fix/*: Bug fixes
# - hotfix/*: Emergency production fixes
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: ['dev', 'main']
  pull_request:
    branches: ['dev', 'main']

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Lint and Type Check
  # ===========================================================================
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    env:
      SKIP_ENV_VALIDATION: '1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --workspace=@askvirtualhealthcare/web

      - name: Run TypeScript check
        run: npm run check --workspace=@askvirtualhealthcare/web

  # ===========================================================================
  # Build
  # ===========================================================================
  build:
    name: Build
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    env:
      # Required for build - using dummy values for CI
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      TWILIO_API_KEY_SECRET: ${{ secrets.TWILIO_API_KEY_SECRET }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_API_KEY_SID: ${{ secrets.TWILIO_API_KEY_SID }}
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ secrets.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: ${{ secrets.NEXT_PUBLIC_CLERK_SIGN_UP_URL }}
      NEXT_PUBLIC_FROM_EMAIL: ${{ secrets.NEXT_PUBLIC_FROM_EMAIL }}
      SKIP_ENV_VALIDATION: '1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build --workspace=@askvirtualhealthcare/web

  # ===========================================================================
  # Unit & Component Tests
  # ===========================================================================
  test:
    name: Run Tests
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    env:
      SKIP_ENV_VALIDATION: '1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:run --workspace=@askvirtualhealthcare/web
# =============================================================================
# Deployment Notes:
# =============================================================================
# Vercel handles deployments automatically:
# - main branch -> Production (askremohealth.com)
# - dev branch -> Preview/Staging
# - PRs -> Preview deployments
#
# No manual deploy step needed - Vercel GitHub integration manages this.
# =============================================================================
