name: ğŸš€ Deploy to Staging & Merge to Main

on:
  push:
    branches:
      - 'staging-config'  # Trigger on push to staging-config
  pull_request:
    branches:
      - 'main'            # Trigger on pull request to main branch

jobs:
  deploy-staging:
    name: Deploy to Staging Subdomain and Merge to Main
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸš€ Deploy to Staging via SSH (systemd)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ğŸ”„ Starting STAGING deployment..."
            cd /root/askremohealth-staging

            # Pull the latest code from staging-config
            git fetch origin
            git reset --mixed origin/staging-config
            
            # Install dependencies and build the app
            echo "ğŸ“¦ Installing dependencies..."
            npm install
            echo "ğŸ› ï¸ Building Next.js app..."
            rm -rf apps/web/.next
            npm run build --workspace=apps/web

            # Restart systemd service
            echo "ğŸ”„ Restarting systemd service for Staging..."
            systemctl restart askremohealth-staging.service
            systemctl status askremohealth-staging.service

            # Health check on port 3001
            echo "â³ Waiting for app to start..."
            sleep 10
            if curl -f http://localhost:3001; then
              echo "âœ… Staging deployment successful!"
            else
              echo "âš ï¸ Staging site not responding on port 3001."
              exit 1
            fi

            echo "ğŸ‰ Staging deployment completed."

      - name: Merge staging-config into main (on successful Staging Deployment)
        if: github.ref == 'refs/heads/staging-config'
        run: |
          echo "ğŸ”€ Merging changes from staging-config to main..."
          git checkout main
          git pull origin main
          git merge staging-config --no-edit
          git push origin main
