name: ğŸš€ Deploy to Production & Merge to Main

on:
  push:
    branches:
      - 'Staging.env'  # Trigger on push to staging.env
  pull_request:
    branches:
      - 'main'         # Trigger on pull request to main branch

jobs:
  deploy:
    name: Deploy to Production and Merge to Main
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
      - uses: actions/checkout@v3
        with:
            fetch-depth: 0

      - name: ğŸš€ Deploy to Production via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ğŸ”„ Starting deployment..."
            cd /root/askremohealth

            # Pull the latest code from the correct branch (staging.env or main)
            echo "ğŸ“¥ Pulling latest code..."
            git checkout ${GITHUB_REF#refs/heads/}  # Uses the correct branch (staging.env or main)
            git pull origin ${GITHUB_REF#refs/heads/}

            # Install dependencies and build the app
            echo "ğŸ“¦ Installing dependencies..."
            npm install
            echo "ğŸ› ï¸ Building Next.js app..."
            rm -rf .next
            npm run build

            # Restart PM2 process and reload Nginx
            echo "ğŸ”„ Restarting PM2 process and reloading Nginx..."
            pm2 restart askremohealth-web
            pm2 save
            nginx -t && systemctl reload nginx

            # Final Health Check
            echo "â³ Waiting for app to start..."
            sleep 10
            if curl -f http://localhost:3000; then
              echo "âœ… Deployment successful!"
            else
              echo "âš ï¸ Site not responding."
              exit 1
            fi

            echo "ğŸ‰ Deployment completed."

      - name: Merge Staging into Main (on successful Staging Deployment)
        if: github.ref == 'refs/heads/Staging.env'  # Only run on staging merge
        run: |
          echo "ğŸ”€ Merging changes from Staging to Main..."
          git checkout main
          git pull origin main
          git merge Staging.env --no-edit
          git push origin main
