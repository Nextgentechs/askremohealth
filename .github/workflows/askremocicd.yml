name: ðŸš€ Deploy to Staging & Merge to Main

on:
  push:
    branches: ['staging-config']
  pull_request:
    branches: ['main']

permissions:
  contents: write

jobs:
  deploy-staging:
    name: Deploy to Staging Subdomain and Merge to Main
    runs-on: ubuntu-latest

    env:
      BRANCH: staging-config
      REPO_DIR: /root/askremohealth-staging
      SERVICE: askremohealth-staging.service
      HEALTH_URL: http://localhost:3001

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸš€ Deploy to Staging via SSH (systemd)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -Eeuo pipefail
            trap 'echo "âŒ Failed at line $LINENO. Last cmd: $BASH_COMMAND"' ERR
            set -x

            echo "ðŸ”„ Starting STAGING deployment..."
            BRANCH="${BRANCH:-staging-config}"
            REPO_DIR="${REPO_DIR:-/root/askremohealth-staging}"
            GIT_URL="git@github.com:Nextgentechs/askremohealth.git"

            # Ensure repo exists and is a git repo
            if [ ! -d "$REPO_DIR/.git" ]; then
              mkdir -p "$REPO_DIR"
              rm -rf "$REPO_DIR"
              git clone --origin origin --branch "$BRANCH" "$GIT_URL" "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            test "$(pwd)" = "$REPO_DIR"

            git remote set-url origin "$GIT_URL"

            # Heal remote-tracking refs, in one fetch (less moving parts)
            git remote prune origin || true
            # If a stale remote ref exists, delete it so fetch can recreate cleanly
            git update-ref -d "refs/remotes/origin/$BRANCH" || true
            git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"

            # Verify branch exists remotely before proceeding
            git rev-parse --verify "refs/remotes/origin/$BRANCH"

            # Checkout/reset local working branch to remote
            if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
              git checkout "$BRANCH"
            else
              git checkout -B "$BRANCH" "refs/remotes/origin/$BRANCH"
            fi
            git reset --hard "refs/remotes/origin/$BRANCH"

            echo "ðŸ“¦ Installing dependencies..."
            if [ -f package-lock.json ]; then
              npm ci || npm install
            else
              npm install
            fi

            echo "ðŸ› ï¸ Building Next.js app..."
            rm -rf apps/web/.next || true
            npm run build --workspace=apps/web

            echo "ðŸ”„ Restarting systemd service for Staging..."
            systemctl restart "${SERVICE}"
            # status returns non-zero if last exit code of service wasn't 0; don't fail deploy on that alone
            systemctl status "${SERVICE}" --no-pager || true

            echo "â³ Health check with retries..."
            for i in $(seq 1 12); do
              if curl -fsS "${HEALTH_URL}" >/dev/null; then
                echo "âœ… Staging deployment healthy at ${HEALTH_URL}"
                break
              fi
              echo "â³ Attempt $i/12: service not ready yet; retrying in 5s..."
              sleep 5
            done

            # Final assert
            curl -fsS "${HEALTH_URL}" >/dev/null

            echo "ðŸŽ‰ Staging deployment completed."

      - name: ðŸ”€ Merge staging-config into main (only after successful deploy)
        if: github.ref == 'refs/heads/staging-config'
        run: |
          set -Eeuo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin --prune
          git checkout main
          git reset --hard origin/main

          # Merge the remote branch we just deployed (not the possibly stale local)
          git merge --no-edit origin/staging-config || true

          git push origin main
